import{Subscription as e,isObservable as t,fromEvent as n,BehaviorSubject as r,ReplaySubject as i,pipe as s,throwError as o}from"rxjs";import{map as l,first as a,tap as d,catchError as h}from"rxjs/operators";export{c as createElement}from"./create-element-8b180327.js";const m=Array.isArray;function u(e){return null==e}function f(e){return"function"==typeof e}function g(e){return"string"==typeof e}function y(e){return!0===e||!1===e}function p(e){const[t,n]=(e=>e?[!g(e)&&e instanceof Element&&e,g(e)&&e]:[null,null])(e);if(t)return t;if(!window||!window.document)throw new Error("Atom-iQ RvDOM Renderer Error: Element/Document is undefined");return n?window.document.querySelector(n):window.document.body}const b=["svg","animate","animateTransform","circle","clipPath","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","foreignObject","g","image","line","linearGradient","marker","mask","metadata","path","pattern","polygon","polyline","radialGradient","rect","stop","switch","symbol","text","textPath","tspan","use","view"],x=(e,t)=>{const n=e.split("."),r=t.split(".");if(n.length>r.length)for(let e=0;e<r.length;e++){const t=Number(n[e]),i=Number(r[e]);if(t!==i)return t-i}else for(let e=0;e<n.length;e++){const t=Number(n[e]),i=Number(r[e]);if(t!==i)return t-i}return 0};function C(e){return!(!e||!e.type)}function F(e,t,n,r,i,s){return o=>{if(console.log("Child Type Switch: ",o),u(o)||y(o))return e&&e();if(function(e){const t=typeof e;return"string"===t||"number"===t}(o))return t(o);if(m(o))return console.log("IS ARRAY"),n(o);if(C(o)){if(l=o,Boolean(f(l.type)&&l._component))return r(o);if(function(e){return g(e.type)&&"_Fragment"===e.type}(o))return i(o);if(function(e){return g(e.type)&&"_Fragment"!==e.type}(o))return s(o)}var l}}function k(e,t,n){return(r,i)=>(console.log("Render type switch, child index: ",r),i.has(r)?(console.log("has one"),e(i.get(r))):i.hasFragment(r)?(console.log("has many"),t(i.getFragment(r))):(console.log("has nothing"),void 0!==n&&n()))}function v(e){return document.createTextNode(String(e))}function E(e,t){return e.appendChild(t)}function w(e,t,n){return e.insertBefore(t,n)}const S=(e,n,r)=>{Object.entries(e).forEach(([e,i])=>{const s=(e.includes("-"),e);t(i)?r.add(i.subscribe(e=>{n.style[s]=e})):n.style[s]=i})},I=(e,t)=>(e,n)=>{const r="class"===e?"className":e;"className"===r?u(n)?t.className="":t.className=String(n):u(n)?t.removeAttribute(r):y(n)?n?t.setAttribute(r,r):t.removeAttribute(r):t.setAttribute(r,String(n))};function O(r,i){const s=new e;var o,c,a,d;return r.props&&Object.entries(r.props).forEach((o=((e,n,r)=>(e,i)=>{t(i)?r.add(i.subscribe(e=>{g(e)?n.setAttribute("style",e):u(e)?n.removeAttribute("style"):S(e,n,r)})):g(i)?n.setAttribute("style",i):u(i)||S(i,n,r)})(0,i,s),c=((e,t,r)=>(i,s)=>{if((e=>e.startsWith("on"))(i))if(((e,t)=>e.endsWith("$"))(i)){const o=i.substr(0,i.length-1),c=o.slice(2).toLocaleLowerCase(),a=l(e=>Object.assign({element:t},e))(n(t,c));r.add(s(a).subscribe(t=>{e.props[o]&&e.props[o](t)}))}else{if(e.props[i+"$"])return;const o=i.slice(2).toLocaleLowerCase(),c=l(e=>Object.assign({element:t},e))(n(t,o));r.add(c.subscribe(e=>s(e)))}})(r,i,s),a=((e,t,n)=>(e,r)=>{n.add(r.subscribe(n=>{I(0,t)(e,n)}))})(0,i,s),d=I(0,i),([e,n])=>{if(!(e=>"children"===e||"key"===e||"ref"===e)(e))return((e,t)=>"style"===e)(e)?o(e,n):f(n)?c(e,n):t(n)?a(e,n):d(e,n)})),s}function N(e){e.subscription&&e.subscription.unsubscribe()}const K=e=>({props:null,type:"_Fragment",children:e}),A=(e,t=!1)=>(n,r)=>{const i=e.get(r)||e.getFragment(r);return i.fragmentChildIndexes?n.concat(i.fragmentChildIndexes.reduce(A(e,t),[])):n.concat(t?i.index:i)};function L(e,t,n,r,i){if(i.empty())E(r,t);else if(i.hasOneChild()){const e=i.getFirstIndex();if(parseInt(n)>parseInt(e))E(r,t);else{w(r,t,i.getFirstChild().element)}}else{const{isFirst:e,isLast:s,nextSibling:o,firstChild:l}=i.getPositionInfoForNewChild(n);e?w(r,t,l.element):s?E(r,t):w(r,t,o.element)}return e({index:n,element:t})}function M(e,t,n,r,i){const s=i.get(n);if(o=r,l=t,c=s.element,o.replaceChild(l,c))return e({index:n,element:t});var o,l,c}function j(e,t,n,r){const i=r.get(t);if(s=n,o=i.element,s.removeChild(o))return e(i);var s,o}class R{constructor(){this[Symbol.iterator]=()=>this.toEntriesArray()[Symbol.iterator](),this.indexes=[],this.children={},this.fragmentIndexes=[],this.fragmentChildren={},this.has=e=>!!this.children[e],this.get=e=>this.children[e],this.hasFragment=e=>!!this.fragmentChildren[e],this.getFragment=e=>this.fragmentChildren[e],this.setFnFactory=(e,t=!1)=>(n,r)=>{try{const i="add"===e,s=t?!!this.fragmentChildren[n]:!!this.children[n];return!!(i?!s:s)&&(t?(i&&(this.fragmentIndexes=this.fragmentIndexes.concat(n)),this.fragmentChildren[n]=r):(i&&(this.indexes=this.indexes.concat(n)),this.children[n]=r),!0)}catch(e){return!1}},this.add=this.setFnFactory("add"),this.replace=this.setFnFactory("replace"),this.addFragment=this.setFnFactory("add",!0),this.replaceFragment=this.setFnFactory("replace",!0),this.createEmptyFragment=e=>this.addFragment(e,{index:e,element:"_Fragment",fragmentChildIndexes:[],fragmentChildKeys:{},fragmentChildrenLength:0}),this.remove=e=>this.has(e)&&this.delete(e),this.removeFragment=e=>this.hasFragment(e)&&this.delete(e,!0),this.size=()=>this.indexes.length,this.empty=()=>0===this.indexes.length,this.getAll=()=>this.indexes.map(e=>this.children[e]),this.getKeys=()=>this.indexes,this.removeAll=()=>(this.indexes=[],this.children={},!0),this.toEntriesArray=()=>this.indexes.map(this.mapToEntry),this.getFirstIndex=()=>this.indexes[0],this.getFirstChild=()=>this.children[this.indexes[0]],this.hasOneChild=()=>1===this.indexes.length,this.delete=(e,t=!1)=>{try{return t?(this.fragmentIndexes=this.fragmentIndexes.filter(t=>t!==e),delete this.fragmentChildren[e]):(this.indexes=this.indexes.filter(t=>t!==e),delete this.children[e]),!0}catch(e){return!1}},this.mapToEntry=e=>[e,this.children[e]],this.getChildOrNull=(e,t)=>e?this.children[t()]:null,this.getPositionInfoForNewChild=e=>{const t=R.sortIndexes(this.indexes.concat(e)),n=t.indexOf(e),r=function(e){return 0===e}(n),i=function(e,t){return e===t.length-1}(n,t),s=this.getChildOrNull(!r,()=>t[0]),o=this.getChildOrNull(!r,()=>t[n-1]),l=this.getChildOrNull(!i,()=>t[n+1]);return{indexInArray:n,allSortedIndexes:t,isFirst:r,isLast:i,previousSibling:o,nextSibling:l,firstChild:s}}}get[Symbol.toStringTag](){return JSON.stringify(this.indexes)}}R.sortIndexes=e=>(e=>e.sort(x))(e);var T=()=>new R;const $=(e,t,n)=>r=>{const i=()=>{L(t=>n.add(e,t),v(String(r)),e,t,n)};k(i=>{M(t=>{N(i),n.replace(e,t)},v(String(r)),e,t,n)},r=>{var s;(s=r,R.sortIndexes(s.fragmentChildIndexes)).forEach(e=>{j(t=>{N(t),n.remove(e)},e,t,n)}),N(r),n.removeFragment(e),i()},i)(e,n)},D=(e,t,n,r,i)=>()=>{const s=e.elementSubscription;s&&i.add(s),L(e=>r.add(t,{...e,subscription:s}),e.dom,t,n,r)},B=(e,t,n,r)=>i=>{i.fragmentChildIndexes.reduce(A(r,!0),[]).forEach(t=>{j(n=>{i.key&&e[i.key]||N(n),r.remove(t)},t,n,r)}),i.key&&e[i.key]||N(i),r.removeFragment(t)},P=(e,t,n,r,i,s,o)=>()=>{const l=i.split(".").length;t.fragmentChildren.forEach(e=>{const t=e.index.split(".").slice(l).join("."),n=`${i}.${t}`;L(t=>{o.add(n,{...t,key:e.key,subscription:e.subscription}),o.has(e.index)&&o.remove(e.index)},e.element,n,s,o)}),r.fragmentChildKeys={...r.fragmentChildKeys,[e.key]:i},delete n[e.key]},_=(e,t,n,r,i,s,o)=>{L(s=>{o.add(i,{...s,key:e.key,subscription:t.child.subscription}),r.fragmentChildKeys={...r.fragmentChildKeys,[e.key]:i},delete n[e.key]},t.child.element,i,s,o)},G=(e,t)=>((e=>e.oldKeyElementMap&&Object.keys(e.oldKeyElementMap).length>0)(t)&&Object.values(t.oldKeyElementMap).forEach(e=>{e.fragmentChildren&&e.fragmentChildren.forEach(e=>N(e)),N(e.child)}),t.oldKeyElementMap=Object.keys(t.fragmentChildKeys).reduce((n,r)=>{const i=t.fragmentChildKeys[r],s=e.get(i)||e.getFragment(i),o=s.fragmentChildIndexes&&s.fragmentChildIndexes.reduce(A(e),[]);return n[r]={index:i,child:s,fragmentChildren:o},n},{}),t.oldKeyElementMap),Q=(e,t,n,r,i)=>(s,o)=>{const l=e[s.key];if(l){if(l.index===o)return((e,t,n,r)=>{t.fragmentChildKeys={...t.fragmentChildKeys,[r]:n},delete e[r],console.log("Skip rendering element with key: ",r)})(e,t,o,s.key);"_Fragment"===l.child.element?((e,t,n,r,i,s,o)=>{k(()=>{j(e=>{o.remove(e.index),e.key&&n[e.key]||N(e)},i,s,o),P(e,t,n,r,i,s,o)()},l=>{B(n,i,s,o)(l),P(e,t,n,r,i,s,o)()},P(e,t,n,r,i,s,o))(i,o)})(s,l,e,t,o,n,r):((e,t,n,r,i,s,o)=>{k(l=>{M(s=>{l.key&&n[l.key]||N(l),o.replace(i,{...s,key:e.key,subscription:t.child.subscription}),r.fragmentChildKeys={...r.fragmentChildKeys,[e.key]:i},delete n[e.key]},t.child.element,i,s,o)},l=>{B(n,i,s,o)(l),_(e,t,n,r,i,s,o)},()=>_(e,t,n,r,i,s,o))(i,o)})(s,l,e,t,o,n,r),console.log("Move child with key: ",s.key)}else t.fragmentChildKeys={...t.fragmentChildKeys,[s.key]:o},console.log("Render child with key: ",s.key),i(s,o)};function U(e,n,r,i,s){return o=>{const l=r.getFragment(e),c=G(r,l);l.fragmentChildKeys={},((e,t,n,r,i,s)=>{const o=s.fragmentChildrenLength,l=r.children.length;if(o>l){const r=o-l;Array.from({length:r},(e,t)=>t+l).forEach(r=>{const s=`${e}.${r}`;n.has(s)?j(e=>{e.key&&i[e.key]||N(e),n.remove(e.index)},s,t,n):n.hasFragment(s)&&B(i,s,t,n)(n.getFragment(s))})}})(e,n,r,o,c,l),o.children.forEach(((e,n,r,i)=>(s,o)=>{const l=`${e}.${o}`;if(t(s)){const e=s.subscribe(e=>{C(e)&&e.key?r(e,l):i(e,l)});n.add(e)}else C(s)&&s.key?r(s,l):i(s,l)})(e,i,Q(c,l,n,r,s),s))}}const W=(e,t,n,r,i)=>s=>{k(((e,t,n,r,i,s)=>()=>{j(o=>(N(o),r.remove(o.index),r.createEmptyFragment(t),U(t,n,r,i,s)(e)),t,n,r)})(s,e,t,n,r,i),((e,t,n,r,i,s)=>()=>U(t,n,r,i,s)(e))(s,e,t,n,r,i),((e,t,n,r,i,s)=>()=>(r.createEmptyFragment(t),U(t,n,r,i,s)(e)))(s,e,t,n,r,i))(e,n)},q=(e,t,n,r,i)=>s=>(n.createEmptyFragment(e),U(e,t,n,r,i)(s)),z=(e,t)=>(t&&C(e)&&(e.key?e.key!==t&&(e.key=`${t}.${e.key}`):e.key=t),e);function H(e,n,r,i,s){return n=>{const r=(o=n,console.log("COMPONENT DEBUG: ",o),o._component((e=>{const t=e.props;return e.children&&(t.children=e.children),t})(o)));var o;console.log("COMPONENT CHILD DEBUG: ",r);const l=n.key||null;if(!t(r))return s(z(r,l),e);{const t=r.subscribe(t=>s(z(t,l),e));i.add(t)}}}const J=(e,t,n,r)=>i=>{const s=ee(i),o=D(s,e,t,n,r);k(((e,t,n,r,i)=>s=>{const o=e.elementSubscription;o&&i.add(o),M(e=>{N(s),r.add(t,{...e,subscription:o})},e.dom,t,n,r)})(s,e,t,n,r),((e,t,n,r,i)=>t=>{t.fragmentChildIndexes.reduce(A(i,!0),[]).forEach(e=>{j(t=>{N(t),i.remove(e)},e,r,i)}),N(t),i.removeFragment(n),e()})(o,0,e,t,n),o)(e,n)},Y=(e,t,n)=>(r,i)=>X(i,e,t,n)(r),V=(...e)=>{const[t,n,r,i]=e;return F(null,((e,t,n)=>r=>{L(t=>n.add(e,t),v(String(r)),e,t,n)})(...e),((...e)=>t=>q(...e)(K(t)))(t,n,r,i,Y(n,r,i)),H(t,0,0,i,Y(n,r,i)),q(t,n,r,i,Y(n,r,i)),((e,t,n,r)=>i=>{const s=ee(i);D(s,e,t,n,r)()})(...e))},X=(...e)=>{const[t,n,r,i]=e;return F(()=>{},$(...e),((...e)=>t=>W(...e)(K(t)))(t,n,r,i,Y(n,r,i)),H(t,0,0,i,Y(n,r,i)),W(t,n,r,i,Y(n,r,i)),J(...e))},Z=(n,r)=>{const i=new e,s=T();return n.forEach(((e,n,r)=>(i,s)=>{const o=String(s);if(t(i)){const t=i.subscribe(X(o,e,n,r));r.add(t)}else V(o,e,n,r)(i)})(r,s,i)),i};function ee(e){const t=(n=e.type,function(e){return b.includes(e.type)}(e)?document.createElementNS("http://www.w3.org/2000/svg",n):document.createElement(n));var n;const r=O(e,t);if(e.children){const n=Z(e.children,t);r.add(n)}return{dom:t,elementSubscription:r}}const te=(t,n)=>r=>{console.log("Living");const i=p(n);if(!t||!i)throw new Error("Root RvdElement and Root Dom cannot be undefined or null");return function(t,n){console.log("rootChild");const r=new e,i=T();return V("0",n,i,r)(t),r}(t,i)},ne=e=>{const t=new r(e),n=t.asObservable();return[n,e=>{f(e)?a()(n).subscribe(e):t.next(e)}]},re=e=>{const t=new i(1);return[t.asObservable(),n=>r=>{const i=e?e(n?n(r):r):n?n(r):r;return s(d(t.next),h(e=>(t.next(e),o(()=>e))))(i)}]};export{ne as createState,re as eventState,te as iQRvdStart,ne as useState};
